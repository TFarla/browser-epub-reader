var $=Object.defineProperty,H=Object.defineProperties;var v=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var A=(t,r,n)=>r in t?$(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n,p=(t,r)=>{for(var n in r||(r={}))j.call(r,n)&&A(t,n,r[n]);if(L)for(var n of L(r))q.call(r,n)&&A(t,n,r[n]);return t},m=(t,r)=>H(t,v(r));import{s as y,j as D,d as J}from"./vendor.d403f47b.js";const U=function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerpolicy&&(i.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?i.credentials="include":o.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}};U();function _(t){return y(t,{allowProtocolRelative:!1,allowedTags:y.defaults.allowedTags.concat(["img","svg","image"]),allowedSchemesByTag:{img:["blob"]},allowedAttributes:m(p({},y.defaults.allowedAttributes),{img:["src","height","width"],image:["xlink:href","height","width"]})})}async function K({bookContents:t,startPage:r,render:n}){let a=r||0;a<0&&(a=0);const o=await D.exports.loadAsync(t),i=await o.file("META-INF/container.xml").async("string"),s=X(i),B=await o.file(s).async("string"),{opf:C,refs:w}=G(B),N=s.split("/").slice(0,-1).join("/");function T(l){return[...N.split("/"),...l.split("/")].filter(c=>c.length>0).reduce((c,f)=>(f===".."?c.pop():c.push(f),c),[]).join("/")}async function g(l){const k=Q(C,w,l),P=await o.file(T(k)).async("string"),c=b(P),f=c.querySelector("body"),R=[...Array.from(c.getElementsByTagName("img")),...Array.from(c.getElementsByTagName("image"))],x=window.URL||window.webkitURL;await Promise.all(R.map(async h=>{try{const u=h.hasAttribute("src")?"src":"xlink:href",F=T(h.getAttribute(u)),O=await o.file(F).async("blob"),M=x.createObjectURL(O);h.setAttribute(u,M)}catch(u){console.error(u);return}})),n({html:_(f.innerHTML),currentPage:a,totalPages:w.length})}return g(a),{next:()=>(a++,g(a)),prev:()=>(a--,g(a)),goTo:l=>(a=l,g(l))}}function b(t){return new DOMParser().parseFromString(t,"application/xml")}function X(t){const r=b(t);return Array.from(r.getElementsByTagName("rootfile")).find(o=>o.hasAttribute("full-path")).getAttribute("full-path")}function G(t){const r=b(t),n=Array.from(r.querySelectorAll("spine > itemref"));return{opf:r,refs:n}}function Q(t,r,n){const a=r[n].getAttribute("idref");return t.getElementById(a).getAttribute("href")}function I(t,r,n){const a={page:r,scrollTop:n||0};localStorage.setItem(t,JSON.stringify(a))}function S(t){const r=localStorage.getItem(t);return r?JSON.parse(r):{page:0}}function E({fontSize:t,lastTitle:r}){localStorage.setItem("reader_config",JSON.stringify({fontSize:t,lastTitle:r}))}function V(){return JSON.parse(localStorage.getItem("reader_config"))||{fontSize:1}}function W(t){try{localStorage.setItem("bookContents",t)}catch(r){console.error(r)}}function Y(){return localStorage.getItem("bookContents")}const Z=({subscribe:t,content:r})=>{const n={get:function(o,i,s){return o[i]},set:function(o,i,s){return t(o,i,s),o[i]=s,!0}};return new Proxy(r,n)},d=V(),e=Z({content:{canAddFurigana:!1,fileInput:document.getElementById("ebookFile"),reader:document.getElementById("reader"),pageProgress:document.getElementById("pageProgress"),pageProgressSlider:document.getElementById("pageProgressSlider"),fontSizeSlider:document.getElementById("fontSize"),toggleFuriganaButton:document.getElementById("toggleFurigana"),percentReport:document.getElementById("percentReport"),bookReader:null,title:"",fontSize:d.fontSize,page:1,totalPages:2,pageContent:"",charLength:0},subscribe:function(t,r,n){switch(r){case"bookContents":W(n),ee(n);break;case"file":e.title=n.name;const a=new FileReader;a.onload=function({target:i}){e.bookContents=i.result},a.readAsBinaryString(n);break;case"title":document.title=n,E(m(p({},d),{lastTitle:n}));break;case"page":e.page!==n&&(e.bookReader.goTo(n),e.canAddFurigana=!0),I(e.title,n,0),e.pageProgress.innerHTML=`${n}/${e.totalPages}`,e.reader.innerText.length===0?e.reader.classList.add("empty"):e.reader.classList.remove("empty"),e.charLength=e.reader.innerText.trim().replace(/^\s*\n/gm,"").length;break;case"totalPages":e.pageProgress.innerHTML=`${e.page}/${n}`;break;case"fontSize":const o=.2*n+1;e.reader.style.fontSize=`${o}em`,e.reader.style.lineHeight=`${o}em`,e.fontSizeSlider.value=n,E(m(p({},d),{fontSize:n}));break;case"canAddFurigana":break;case"pageContent":e.reader.innerHTML=n,e.reader.scrollTo({top:0});break}}});pageProgressSlider.addEventListener("input",t=>{const r=parseInt(t.currentTarget.value);e.page=r-1});e.fontSizeSlider.addEventListener("change",t=>{e.fontSize=parseInt(t.currentTarget.value)});e.fileInput.addEventListener("change",t=>{const[r]=t.target.files;!r||(e.file=r)});e.fontSize=d.fontSize;function ee(t){K({bookContents:t,startPage:re(),render:({html:r,currentPage:n,totalPages:a})=>{e.totalPages=a,e.pageProgress.innerHTML=`${n+1}/${a}`,e.pageProgressSlider.max=a,e.pageProgressSlider.value=n+1,e.pageContent=r,e.page=n}}).then(r=>{e.bookReader=r})}window.addEventListener("keydown",te);function te(t){!e.bookReader||(t.key==="a"&&e.page--,t.key==="d"&&e.page++)}function re(){return S(e.title).page}const z=Y();if(z&&d.lastTitle){e.title=d.lastTitle,e.bookContents=z;let t=S(e.title);window.setTimeout(()=>{e.reader.scrollTo({top:t.scrollTop})},1e3)}e.reader.onscroll=J(()=>{const t=S(e.title);if(t){const r=e.reader.scrollTop,n=e.reader.scrollHeight,a=Math.round(r/n*100);e.percentReport.innerHTML=`${a}%`,I(e.title,t.page,e.reader.scrollTop),document.getElementById("charReport").innerText=`${Math.round(e.charLength*(a/100))} / ${e.charLength} chars`}},400);document.querySelector('div[data-action="prev"]').addEventListener("click",()=>{e.page--});document.querySelector('div[data-action="next"]').addEventListener("click",()=>{e.page++});
