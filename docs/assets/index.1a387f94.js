var $=Object.defineProperty,H=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var D=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var A=(e,t,n)=>t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,p=(e,t)=>{for(var n in t||(t={}))D.call(t,n)&&A(e,n,t[n]);if(L)for(var n of L(t))J.call(t,n)&&A(e,n,t[n]);return e},m=(e,t)=>H(e,j(t));import{s as y,j as U,d as _}from"./vendor.d403f47b.js";const q=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerpolicy&&(i.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?i.credentials="include":o.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}};q();function v(e){return y(e,{allowProtocolRelative:!1,allowedTags:y.defaults.allowedTags.concat(["img","svg","image"]),allowedSchemesByTag:{img:["blob"]},allowedAttributes:m(p({},y.defaults.allowedAttributes),{img:["src","height","width"],image:["xlink:href","height","width"]})})}async function K({bookContents:e,startPage:t,render:n}){let a=t||0;a<0&&(a=0);const o=await U.exports.loadAsync(e),i=await o.file("META-INF/container.xml").async("string"),s=X(i),z=await o.file(s).async("string"),{opf:C,refs:w}=G(z),N=s.split("/").slice(0,-1).join("/");function T(l){return[...N.split("/"),...l.split("/")].filter(c=>c.length>0).reduce((c,f)=>(f===".."?c.pop():c.push(f),c),[]).join("/")}async function d(l){const P=Q(C,w,l),k=await o.file(T(P)).async("string"),c=b(k),f=c.querySelector("body"),R=[...Array.from(c.getElementsByTagName("img")),...Array.from(c.getElementsByTagName("image"))],F=window.URL||window.webkitURL;await Promise.all(R.map(async h=>{try{const u=h.hasAttribute("src")?"src":"xlink:href",O=T(h.getAttribute(u)),x=await o.file(O).async("blob"),M=F.createObjectURL(x);h.setAttribute(u,M)}catch(u){console.error(u);return}})),n({html:v(f.innerHTML),currentPage:a,totalPages:w.length})}return d(a),{next:()=>(a++,d(a)),prev:()=>(a--,d(a)),goTo:l=>(a=l,d(l))}}function b(e){return new DOMParser().parseFromString(e,"application/xml")}function X(e){const t=b(e);return Array.from(t.getElementsByTagName("rootfile")).find(o=>o.hasAttribute("full-path")).getAttribute("full-path")}function G(e){const t=b(e),n=Array.from(t.querySelectorAll("spine > itemref"));return{opf:t,refs:n}}function Q(e,t,n){const a=t[n].getAttribute("idref");return e.getElementById(a).getAttribute("href")}function I(e,t,n){const a={page:t,scrollTop:n||0};localStorage.setItem(e,JSON.stringify(a))}function S(e){const t=localStorage.getItem(e);return t?JSON.parse(t):{page:0}}function B({fontSize:e,lastTitle:t}){localStorage.setItem("reader_config",JSON.stringify({fontSize:e,lastTitle:t}))}function V(){return JSON.parse(localStorage.getItem("reader_config"))||{fontSize:1}}function W(e){try{localStorage.setItem("bookContents",e)}catch(t){console.error(t)}}function Y(){return localStorage.getItem("bookContents")}const Z=({subscribe:e,content:t})=>{const n={get:function(o,i,s){return o[i]},set:function(o,i,s){return e(o,i,s),o[i]=s,!0}};return new Proxy(t,n)},g=V(),r=Z({content:{canAddFurigana:!1,fileInput:document.getElementById("ebookFile"),reader:document.getElementById("reader"),pageProgress:document.getElementById("pageProgress"),pageProgressSlider:document.getElementById("pageProgressSlider"),fontSizeSlider:document.getElementById("fontSize"),toggleFuriganaButton:document.getElementById("toggleFurigana"),percentReport:document.getElementById("percentReport"),bookReader:null,title:"",fontSize:g.fontSize,page:1,totalPages:2,pageContent:"",charLength:0},subscribe:function(e,t,n){switch(t){case"bookContents":W(n),ee(n);break;case"file":r.title=n.name;const a=new FileReader;a.onload=function({target:o}){r.bookContents=o.result},a.readAsBinaryString(n);break;case"title":document.title=n,B(m(p({},g),{lastTitle:n}));break;case"page":r.page!==n&&(r.bookReader.goTo(n),r.canAddFurigana=!0),I(r.title,n,0),r.pageProgress.innerHTML=`${n}/${r.totalPages}`,r.reader.innerText.length===0?r.reader.classList.add("empty"):r.reader.classList.remove("empty"),r.charLength=r.reader.innerText.trim().replace(/^\s*\n/gm,"").length;break;case"totalPages":r.pageProgress.innerHTML=`${r.page}/${n}`;break;case"fontSize":r.reader.style.fontSize=`${n}em`,r.reader.style.lineHeight=`${n}em`,r.fontSizeSlider.value=n,B(m(p({},g),{fontSize:n}));break;case"canAddFurigana":break;case"pageContent":r.reader.innerHTML=n,r.reader.scrollTo({top:0});break}}});pageProgressSlider.addEventListener("input",e=>{const t=parseInt(e.currentTarget.value);r.page=t-1});r.fontSizeSlider.addEventListener("change",e=>{r.fontSize=parseInt(e.currentTarget.value)});r.fileInput.addEventListener("change",e=>{const[t]=e.target.files;!t||(r.file=t)});r.fontSize=g.fontSize;function ee(e){K({bookContents:e,startPage:re(),render:({html:t,currentPage:n,totalPages:a})=>{r.totalPages=a,r.pageProgress.innerHTML=`${n+1}/${a}`,r.pageProgressSlider.max=a,r.pageProgressSlider.value=n+1,r.pageContent=t,r.page=n}}).then(t=>{r.bookReader=t})}window.addEventListener("keydown",te);function te(e){!r.bookReader||(e.key==="a"&&r.page--,e.key==="d"&&r.page++)}function re(){return S(r.title).page}const E=Y();if(E&&g.lastTitle){r.title=g.lastTitle,r.bookContents=E;let e=S(r.title);window.setTimeout(()=>{r.reader.scrollTo({top:e.scrollTop})},1e3)}r.reader.onscroll=_(()=>{const e=S(r.title);if(e){const t=r.reader.scrollTop,n=r.reader.scrollHeight,a=Math.round(t/n*100);r.percentReport.innerHTML=`${a}%`,I(r.title,e.page,r.reader.scrollTop),document.getElementById("charReport").innerText=`${Math.round(r.charLength*(a/100))} / ${r.charLength} chars`}},400);
